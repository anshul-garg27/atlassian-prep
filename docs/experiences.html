<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlassian Interview Experiences</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>

    <!-- Load Experiences Data -->
    <script src="experiences_data.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; 
        }

        /* Markdown Styles Override for Dark Mode */
        .markdown-body h1 { font-size: 2.25rem; font-weight: 800; margin-bottom: 1.5rem; color: #60a5fa; border-bottom: 1px solid #334155; padding-bottom: 0.5rem; }
        .markdown-body h2 { font-size: 1.875rem; font-weight: 700; margin-top: 2rem; margin-bottom: 1rem; color: #93c5fd; }
        .markdown-body h3 { font-size: 1.5rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #bfdbfe; }
        .markdown-body p { margin-bottom: 1rem; line-height: 1.75; color: #e2e8f0; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; color: #cbd5e1; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 1rem; color: #cbd5e1; }
        .markdown-body blockquote { border-left: 4px solid #3b82f6; padding-left: 1rem; font-style: italic; color: #94a3b8; background: #1e293b; padding: 1rem; border-radius: 0 0.5rem 0.5rem 0; margin-bottom: 1rem; }
        .markdown-body code { background-color: #334155; color: #e2e8f0; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.9em; }
        
        /* Code Blocks */
        .markdown-body pre { 
            background-color: #1e293b; 
            padding: 0; /* Padding handled by wrapper */
            border-radius: 0.5rem; 
            overflow-x: auto; 
            margin-bottom: 1.5rem; 
            border: 1px solid #334155;
            color: #f3f4f6 !important; /* Force light text */
        }
        .markdown-body pre code { 
            background-color: transparent; 
            padding: 1rem; 
            display: block; 
            color: inherit; /* Inherit form pre */
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Code Block Wrapper & Badge */
        .code-block-wrapper {
            position: relative;
            margin-bottom: 1.5rem;
        }
        .language-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #334155;
            color: #94a3b8;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-bottom-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            text-transform: uppercase;
            z-index: 10;
        }

        /* Fix for HLJS text color override */
        .hljs {
            color: #abb2bf !important; /* Atom One Dark default text color */
            background: transparent !important;
        }
        
        .markdown-body a { color: #60a5fa; text-decoration: underline; text-underline-offset: 4px; }
        .markdown-body a:hover { color: #93c5fd; }
        
        .markdown-body hr { border: 0; border-top: 1px solid #334155; margin: 2rem 0; }
        
        /* Table Styles */
        .markdown-body table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        .markdown-body th, .markdown-body td { border: 1px solid #334155; padding: 0.75rem; text-align: left; }
        .markdown-body th { background-color: #1e293b; font-weight: 600; color: #93c5fd; }
        .markdown-body tr:nth-child(even) { background-color: #0f172a; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Markdown Renderer Setup ---
        const renderer = new marked.Renderer();
        
        // Custom Link Renderer for external vs internal links
        renderer.link = function(href, title, text) {
            let actualHref = href;
            let actualText = text;
            
            if (typeof href === 'object' && href !== null) {
                actualHref = href.href;
                actualText = href.text;
            }

            return `<a href="${actualHref}" target="_blank" rel="noopener noreferrer">${actualText}</a>`;
        };

        renderer.code = function(codeBlock, language) {
            let code = codeBlock;
            let lang = language;

            if (typeof codeBlock === 'object' && codeBlock !== null) {
                code = codeBlock.text || '';
                lang = codeBlock.lang || '';
            }

            code = String(code);
            const validLang = !!(lang && hljs.getLanguage(lang));
            
            let highlighted;
            try {
                if (validLang) {
                    const result = hljs.highlight(code, { language: lang });
                    highlighted = result.value;
                } else {
                    const result = hljs.highlightAuto(code);
                    highlighted = result.value;
                }
            } catch (e) {
                highlighted = code;
            }

            let displayLang = lang || 'text';
            if (displayLang === 'python') displayLang = 'Python';
            if (displayLang === 'js' || displayLang === 'javascript') displayLang = 'JavaScript';
            if (displayLang === 'ts' || displayLang === 'typescript') displayLang = 'TypeScript';
            if (displayLang === 'bash') displayLang = 'Terminal';

            return `
                <div class="code-block-wrapper">
                    <span class="language-badge">${displayLang}</span>
                    <pre><code class="hljs ${lang || ''}">${highlighted}</code></pre>
                </div>
            `;
        };

        marked.setOptions({
            renderer: renderer,
            gfm: true,
            breaks: true
        });

        // --- Components ---

        const Sidebar = ({ items, activeItem, onItemClick }) => {
            const [searchTerm, setSearchTerm] = useState("");
            const [activeFilter, setActiveFilter] = useState("All");

            const filters = ["All", "DSA", "HLD", "LLD"];

            const filteredItems = useMemo(() => {
                let result = items;

                // Filter by Tag
                if (activeFilter !== "All") {
                    result = result.filter(item => 
                        item.tags && item.tags.some(tag => tag.name === activeFilter)
                    );
                }

                // Filter by Search Term
                if (searchTerm) {
                    const lowerTerm = searchTerm.toLowerCase();
                    result = result.filter(item => 
                        item.title.toLowerCase().includes(lowerTerm) ||
                        (item.tags && item.tags.some(tag => tag.name.toLowerCase().includes(lowerTerm)))
                    );
                }

                return result;
            }, [items, searchTerm, activeFilter]);

            return (
                <div className="w-96 bg-slate-900 border-r border-slate-800 h-full flex flex-col">
                    <div className="p-6 border-b border-slate-800 bg-slate-900 z-10">
                        <h1 className="text-xl font-bold text-blue-400 tracking-tight">
                            Interview Experiences üìù
                        </h1>
                        <p className="text-xs text-slate-500 mt-2 uppercase font-semibold tracking-wider">
                            {items.length} Articles
                        </p>

                        <nav className="flex gap-4 text-xs font-medium text-slate-400 mt-4">
                            <a href="index.html" className="hover:text-white transition-colors">DSA</a>
                            <a href="code_design.html" className="hover:text-white transition-colors">LLD</a>
                            <a href="experiences.html" className="text-blue-400 hover:text-white">Experiences</a>
                        </nav>
                        
                        {/* Filter Buttons */}
                        <div className="flex gap-2 mt-4">
                            {filters.map(filter => (
                                <button
                                    key={filter}
                                    onClick={() => setActiveFilter(filter)}
                                    className={`px-3 py-1 rounded text-xs font-medium transition-colors ${
                                        activeFilter === filter
                                            ? 'bg-blue-500 text-white'
                                            : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                                    }`}
                                >
                                    {filter}
                                </button>
                            ))}
                        </div>

                        <input 
                            type="text"
                            placeholder="Search experiences..."
                            className="mt-4 w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm text-slate-200 focus:outline-none focus:border-blue-500"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 space-y-1">
                        {filteredItems.map((item, idx) => {
                            const isActive = activeItem && activeItem.uuid === item.uuid;
                            return (
                                <button
                                    key={item.uuid || idx}
                                    onClick={() => onItemClick(item)}
                                    className={`w-full text-left px-4 py-3 rounded-lg text-sm transition-all duration-200 group flex flex-col ${
                                        isActive 
                                            ? 'bg-blue-500/10 text-blue-400 border border-blue-500/20 shadow-[0_0_15px_rgba(59,130,246,0.1)]' 
                                            : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'
                                    }`}
                                >
                                    <span className="font-medium line-clamp-2 mb-1">
                                        {item.title}
                                    </span>
                                    <div className="flex flex-wrap gap-1">
                                        {item.tags && item.tags.slice(0, 3).map(tag => (
                                            <span key={tag.slug} className="text-[10px] px-1.5 py-0.5 bg-slate-800 rounded text-slate-500">
                                                {tag.name}
                                            </span>
                                        ))}
                                    </div>
                                </button>
                            );
                        })}
                        {filteredItems.length === 0 && (
                            <div className="text-center text-slate-500 py-8">
                                No matches found
                            </div>
                        )}
                    </div>
                    
                    <div className="p-4 border-t border-slate-800 text-xs text-slate-600 text-center">
                    </div>
                </div>
            );
        };

        const ContentArea = ({ content, title, tags, summary, uuid, onTagsUpdate }) => {
            const htmlContent = useMemo(() => {
                if (!content) return '';
                try {
                    return marked.parse(content);
                } catch (e) {
                    return `<p class="text-red-400">Error rendering markdown: ${e.message}</p>`;
                }
            }, [content]);

            // Local state for optimistic updates
            const [isUpdating, setIsUpdating] = useState(false);

            const handleTagToggle = async (tagName) => {
                if (isUpdating) return;
                setIsUpdating(true);

                const currentTagNames = tags 
                    ? tags.filter(t => ["DSA", "HLD", "LLD"].includes(t.name)).map(t => t.name)
                    : [];
                
                let newTagNames;
                if (currentTagNames.includes(tagName)) {
                    newTagNames = currentTagNames.filter(t => t !== tagName);
                } else {
                    newTagNames = [...currentTagNames, tagName];
                }

                try {
                    const response = await fetch('http://localhost:8000/api/update-tags', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            uuid: uuid,
                            tags: newTagNames
                        })
                    });

                    if (response.ok) {
                        onTagsUpdate(uuid, newTagNames);
                    } else {
                        console.error("Failed to update tags");
                        alert("Failed to update tags. Is the local server running?");
                    }
                } catch (e) {
                    console.error("Error updating tags:", e);
                    alert("Error updating tags. Make sure server.py is running.");
                } finally {
                    setIsUpdating(false);
                }
            };

            if (!content) {
                return (
                    <div className="flex-1 flex items-center justify-center text-slate-500 flex-col animate-pulse">
                        <div className="w-16 h-16 bg-slate-800 rounded-full mb-4 flex items-center justify-center">
                            <svg className="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>
                        </div>
                        <p>Select an experience to read</p>
                    </div>
                );
            }

            const categoryTags = ["DSA", "HLD", "LLD"];

            return (
                <div className="flex-1 overflow-y-auto bg-slate-950 relative">
                    <div className="max-w-4xl mx-auto px-8 py-12">
                        <div className="flex justify-between items-start mb-4">
                            <h1 className="text-3xl font-bold text-blue-400 flex-1 mr-4">{title}</h1>
                            
                            {/* Tag Toggles */}
                            <div className="flex gap-2 bg-slate-900 p-2 rounded-lg border border-slate-800 shrink-0">
                                {categoryTags.map(tag => {
                                    const isSelected = tags && tags.some(t => t.name === tag);
                                    return (
                                        <button
                                            key={tag}
                                            onClick={() => handleTagToggle(tag)}
                                            disabled={isUpdating}
                                            className={`px-3 py-1 rounded text-xs font-bold transition-all ${
                                                isSelected 
                                                    ? 'bg-blue-500 text-white shadow-lg shadow-blue-500/20' 
                                                    : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                                            } ${isUpdating ? 'opacity-50 cursor-not-allowed' : ''}`}
                                        >
                                            {tag}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                        
                        {tags && tags.length > 0 && (
                            <div className="flex flex-wrap gap-2 mb-6">
                                {tags.filter(t => !categoryTags.includes(t.name)).map(tag => (
                                    <span key={tag.slug} className="text-xs px-2 py-1 bg-slate-800 rounded-full text-blue-300 border border-slate-700">
                                        {tag.name}
                                    </span>
                                ))}
                            </div>
                        )}

                        {summary && (
                            <div className="bg-slate-900/50 border-l-4 border-blue-500 p-4 mb-8 rounded-r text-slate-300 italic">
                                {summary}
                            </div>
                        )}

                        <div 
                            className="markdown-body"
                            dangerouslySetInnerHTML={{ __html: htmlContent }}
                        />
                        <div className="h-24"></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [items, setItems] = useState([]);
            const [activeItem, setActiveItem] = useState(null);

            useEffect(() => {
                if (window.EXPERIENCES_DATA && window.EXPERIENCES_DATA.articles) {
                    setItems(window.EXPERIENCES_DATA.articles);
                    
                    if (window.EXPERIENCES_DATA.articles.length > 0) {
                        setActiveItem(window.EXPERIENCES_DATA.articles[0]);
                    }
                }
            }, []);

            const handleTagsUpdate = (uuid, newTagNames) => {
                // Update items state
                const updatedItems = items.map(item => {
                    if (item.uuid === uuid) {
                        const existingTags = item.tags ? item.tags.filter(t => !["DSA", "HLD", "LLD"].includes(t.name)) : [];
                        const newTags = newTagNames.map(name => ({
                            name,
                            slug: name.toLowerCase(),
                            tagType: "CATEGORY"
                        }));
                        return { ...item, tags: [...existingTags, ...newTags] };
                    }
                    return item;
                });

                setItems(updatedItems);
                
                // Update active item if needed
                if (activeItem && activeItem.uuid === uuid) {
                    const updatedActiveItem = updatedItems.find(i => i.uuid === uuid);
                    setActiveItem(updatedActiveItem);
                }
            };

            return (
                <div className="flex h-screen bg-slate-950 text-slate-200">
                    <Sidebar 
                        items={items} 
                        activeItem={activeItem} 
                        onItemClick={setActiveItem} 
                    />
                    <ContentArea 
                        content={activeItem?.content} 
                        title={activeItem?.title}
                        tags={activeItem?.tags}
                        summary={activeItem?.summary}
                        uuid={activeItem?.uuid}
                        onTagsUpdate={handleTagsUpdate}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

